{% extends "base.html" %}
{% block title %}Login{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6 col-lg-5">
    <div class="card shadow-sm">
      <div class="card-body p-4">
        <h1 class="h5 mb-3">Sign in</h1>

        <div id="alertBox" class="alert d-none" role="alert"></div>

        <form id="loginForm">
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input id="email" type="email" class="form-control" autocomplete="email" required>
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <input id="password" type="password" class="form-control" autocomplete="current-password" required>
          </div>

          <button class="btn btn-primary w-100" type="submit">Login</button>
        </form>

        <div id="tokenBox" class="mt-3 d-none">
          <label class="form-label mb-1">Access Token</label>
          <pre class="border rounded p-2 bg-light small mb-2" id="tokenPre" style="white-space: pre-wrap;"></pre>
          <button class="btn btn-outline-secondary btn-sm" id="copyBtn" type="button">Copy token</button>
        </div>

        <hr class="my-4">
        <p class="text-muted mb-0 small">
          This page calls <code>POST /auth/login</code> using JSON.
        </p>
      </div>
    </div>
  </div>
</div>

<script>
const form = document.getElementById("loginForm");
const alertBox = document.getElementById("alertBox");
const tokenBox = document.getElementById("tokenBox");
const tokenPre = document.getElementById("tokenPre");
const copyBtn = document.getElementById("copyBtn");

function showAlert(type, msg) {
  alertBox.className = "alert alert-" + type;
  alertBox.textContent = msg;
  alertBox.classList.remove("d-none");
}

form.addEventListener("submit", async (e) => {
  e.preventDefault();
  alertBox.classList.add("d-none");
  tokenBox.classList.add("d-none");
  tokenPre.textContent = "";

  const email = document.getElementById("email").value.trim();
  const password = document.getElementById("password").value;

  const res = await fetch("/auth/login", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ email, password })
  });

  const data = await res.json().catch(() => null);

  if (!res.ok) {
    showAlert("danger", data?.error?.message || "Login failed");
    return;
  }

  // since we standardized backend response:
  const token = data?.data?.access_token;

  if (!token) {
    showAlert("danger", "No token returned. Check /auth/login response JSON.");
    return;
  }

  tokenPre.textContent = token;
  tokenBox.classList.remove("d-none");
  showAlert("success", "Token issued.");

  localStorage.setItem("access_token", token);
  window.location.href = "/auth/app";
});



copyBtn.addEventListener("click", () => {
  const token = tokenPre.textContent.trim();
  if (!token) {
    showAlert("warning", "No token to copy.");
    return;
  }

  // most reliable fallback approach
  const tmp = document.createElement("textarea");
  tmp.value = token;
  document.body.appendChild(tmp);
  tmp.select();
  const ok = document.execCommand("copy");
  document.body.removeChild(tmp);

  showAlert(ok ? "success" : "warning", ok ? "Token copied to clipboard." : "Copy failed. Copy manually.");
});
</script>
{% endblock %}